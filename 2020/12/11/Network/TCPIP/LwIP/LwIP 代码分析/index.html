<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"snowyang.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="LwIP æ¶æ„å’Œä»£ç åˆ†æã€‚ æœ¬æ–‡ä½¿ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 2.0.3">
<meta property="og:type" content="article">
<meta property="og:title" content="LwIP ä»£ç åˆ†æ">
<meta property="og:url" content="https://snowyang.com/2020/12/11/Network/TCPIP/LwIP/LwIP%20%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="å†·é¦™å°ç­‘">
<meta property="og:description" content="LwIP æ¶æ„å’Œä»£ç åˆ†æã€‚ æœ¬æ–‡ä½¿ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 2.0.3">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://snowyang.com/Users/snowyang/markdown/resources/LwIP/dhcp_options.png">
<meta property="og:image" content="https://snowyang.com/resources/TCP:IP/%5Blwip%5D-udp_pcb.jpg">
<meta property="article:published_time" content="2020-12-11T12:01:32.317Z">
<meta property="article:modified_time" content="2020-12-11T12:01:32.317Z">
<meta property="article:author" content="Snow Yang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://snowyang.com/Users/snowyang/markdown/resources/LwIP/dhcp_options.png">

<link rel="canonical" href="https://snowyang.com/2020/12/11/Network/TCPIP/LwIP/LwIP%20%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>LwIP ä»£ç åˆ†æ | å†·é¦™å°ç­‘</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c946d75c051cf3fd9b2873d44f7a553e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">å†·é¦™å°ç­‘</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Snow Yang çš„åšå®¢</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://snowyang.com/2020/12/11/Network/TCPIP/LwIP/LwIP%20%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Snow Yang">
      <meta itemprop="description" content="åƒå¤é£æµä»Šåœ¨æ­¤ï¼Œä¸‡é‡ŒåŠŸåè«æ”¾ä¼‘">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="å†·é¦™å°ç­‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LwIP ä»£ç åˆ†æ
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-12-11 20:01:32" itemprop="dateCreated datePublished" datetime="2020-12-11T20:01:32+08:00">2020-12-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LwIP/" itemprop="url" rel="index"><span itemprop="name">LwIP</span></a>
                </span>
            </span>

          
            <span id="/2020/12/11/Network/TCPIP/LwIP/LwIP%20%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" class="post-meta-item leancloud_visitors" data-flag-title="LwIP ä»£ç åˆ†æ" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>LwIP æ¶æ„å’Œä»£ç åˆ†æã€‚</p>
<p>æœ¬æ–‡ä½¿ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 2.0.3</p>
<a id="more"></a>

<h2 id="LwIP"><a href="#LwIP" class="headerlink" title="LwIP"></a>LwIP</h2><p>LwIP å®˜æ–¹ç½‘ç«™ï¼š</p>
<p><a target="_blank" rel="noopener" href="http://savannah.nongnu.org/projects/lwip/">http://savannah.nongnu.org/projects/lwip/</a></p>
<p>Git ä»“åº“ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lwIP - A Lightweight TCPIP stack</span><br><span class="line">git clone https:&#x2F;&#x2F;git.savannah.nongnu.org&#x2F;git&#x2F;lwip.git</span><br><span class="line"></span><br><span class="line">Unnamed repository; edit this file &#39;description&#39; to name the repository.</span><br><span class="line">git clone https:&#x2F;&#x2F;git.savannah.nongnu.org&#x2F;git&#x2F;lwip&#x2F;lwip-contrib.git</span><br></pre></td></tr></table></figure>

<p>lwip-contrib ä»“åº“ç”¨ä»¥ä¸€äº›ç‰›é€¼çš„ç¬¬ä¸‰æ–¹å¼€å‘è€…è´¡çŒ®è‡ªå·±çš„ä»£ç ã€‚å†…æœ‰å„ç§å„æ ·ç‰›é€¼åˆå®ç”¨çš„ä»£ç ï¼Œæ¯”å¦‚ pingï¼Œshell, httpd ä»¥åŠåœ¨ win32, unix ä¸Šçš„ portã€‚è¿™äº›ä»£ç éƒ½æ˜¯ç»è¿‡å®˜æ–¹å®¡æŸ¥çš„ï¼Œå°±æ¯”å¦‚ ping è‚¯å®šæ¯”é‚£äº›é‡ç”Ÿçš„ ping è¦å¥½ç”¨å’Œç¨³å®šã€‚</p>
<h2 id="LwIP-ç†è§£"><a href="#LwIP-ç†è§£" class="headerlink" title="LwIP ç†è§£"></a>LwIP ç†è§£</h2><p>æˆ‘è§‰å¾—åè®®æ ˆä¸­çš„ <code>æ ˆ</code> å­—ç”¨çš„ç‰¹åˆ«ç²¾ç¡®ï¼Œåè®®æ ˆå°±æ˜¯ä¸€å±‚å±‚åè®®æ­å»ºèµ·æ¥çš„æ ˆï¼Œä¸€å±‚åè®®è´Ÿè´£ä¸€ç§èŒèƒ½ï¼Œæ•°æ®åœ¨æ ˆä¸­è‡ªä¸‹è€Œä¸Šæˆ–è€…è‡ªä¸Šè€Œä¸‹çš„ä¼ è¾“ã€‚æ¯”å¦‚å‘é€ä¸€ä¸ª TCP æŠ¥æ–‡ï¼Œå°±è‡ªä¸Šè€Œä¸‹åœ°ç»è¿‡äº†è´Ÿè´£å¯é ä¼ è¾“çš„ä¼ è¾“å±‚ï¼Œè´Ÿè´£è·¯ç”±å’Œè½¬å‘çš„ç½‘ç»œå±‚ï¼Œæœ€ç»ˆç”±ç‰©ç†å±‚è½¬æ¢ä¸ºä¿¡å·å‘é€å‡ºå»ï¼›è€Œæ¥æ”¶åˆ°ä¸€ä¸ªåŸå§‹æ•°æ®åŒ…ï¼Œå°±è‡ªä¸‹è€Œä¸Šåœ°ç»è¿‡ç½‘ç»œå±‚å’Œä¼ è¾“å±‚çš„å¤„ç†ï¼Œç„¶åé€’äº¤ç»™ç”¨æˆ·ã€‚</p>
<h2 id="LwIP-ç§»æ¤"><a href="#LwIP-ç§»æ¤" class="headerlink" title="LwIP ç§»æ¤"></a>LwIP ç§»æ¤</h2><ol>
<li><p>éœ€è¦ç¼–è¯‘å“ªäº› .cï¼Œéœ€è¦åŒ…å«å“ªäº› .hï¼Ÿ</p>
<p>åœ¨ src ç›®å½•ä¸‹æœ‰ Filelists.mk æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº† LwIP å„ç§åŠŸèƒ½æ‰€éœ€çš„ .cã€‚</p>
<p>æ‰€æœ‰çš„ .h éƒ½åœ¨ include ç›®å½•ä¸‹ï¼Œå¹¶ä¸”éƒ½æ˜¯ä»¥ç›¸å¯¹è·¯å¾„çš„æ–¹å¼å¼•ç”¨çš„ï¼Œæ‰€ä»¥åªéœ€è¦æŠŠ include åŠ å…¥å¤´æ–‡ä»¶æœç´¢è·¯å¾„å³å¯ã€‚</p>
<p>å½“ç„¶ï¼Œæœ€å¿«æœ€ä¿é™©çš„æ–¹æ³•è¿˜æ˜¯ç›´æ¥ç”¨ STM32CubeMX ç”Ÿæˆä¸€ä¸ª FreeRTOS + LwIP ä¾‹ç¨‹ã€‚</p>
</li>
<li><p>éœ€è¦ç”¨æˆ·ç§»æ¤å“ªäº›æ–‡ä»¶ï¼Ÿ</p>
<p>å‚è€ƒã€ŠåµŒå…¥å¼ç½‘ç»œé‚£äº›äº‹ã€‹ï¼Œç”¨æˆ·åªéœ€ç§»æ¤ lwipopts.h, perf.h å’Œ cc.h è¿™ 3 ä¸ªå¤´æ–‡ä»¶å³å¯å®Œæˆå†…æ ¸ï¼ˆæ—  OSï¼‰çš„ç§»æ¤ï¼Œè‹¥ä½¿ç”¨ OSï¼Œè¿˜éœ€é¢å¤–ç§»æ¤ sys_arch.c/.h è¿™ 2 ä¸ªæ–‡ä»¶ã€‚</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>lwipopts.h</td>
<td>LwIP configuration</td>
</tr>
<tr>
<td>perf.h</td>
<td>Architecture specific performance measurement.</td>
</tr>
<tr>
<td>cc.h</td>
<td>Architecture environment, some compiler specific, some environment specific.</td>
</tr>
<tr>
<td>sys_arch.c/.h</td>
<td>Abstract operation system  layer.</td>
</tr>
</tbody></table>
<p> <a href="resources/LwIP/doc/sys_arch.txt">doc/sys_arch.txt</a> å¯èƒ½æ²¡æœ‰åŠæ—¶æ›´æ–°ï¼Œå…¶å®åœ¨ 2.0.3 ä¸­ï¼Œcc.h ä¸­çš„å¤§éƒ¨åˆ†å®šä¹‰åœ¨ include/lwip/arch.h ä¸­å·²ç»æœ‰é»˜è®¤å®šä¹‰äº†ï¼Œå¯¹äº ARM + GCC å¹³å°å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚lwip_contrib çš„ master åˆ†æ”¯æœ€æ–° commit ä¸Šçš„ ports/unix å¯ä¾› ARM + GCC å‚è€ƒï¼Œå…¶ port/include/arch/cc.h å†…å…¶å®åªå®šä¹‰äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define LWIP_TIMEVAL_PRIVATE 0</span><br><span class="line">#include &lt;sys&#x2F;time.h&gt;</span><br><span class="line">#define LWIP_ERRNO_INCLUDE &lt;errno.h&gt;</span><br><span class="line">#define LWIP_RAND() ((u32_t)rand())</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰åœ¨ lwipopts.h å†…å®šä¹‰ LWIP_PERFï¼Œåˆ™æ— éœ€ perf.hã€‚</p>
<p>å¯¹äº sys_arch.hï¼Œ<a href="resources/LwIP/doc/sys_arch.txt">doc/sys_arch.txt</a>  å†…è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>sys_arch.h - Tied to sys_arch.c</p>
<p>Arch dependent types for the following objects:<br> sys_sem_t, sys_mbox_t, sys_thread_t,<br>And, optionally:<br> sys_prot_t</p>
<p>Defines to set vars of sys_mbox_t and sys_sem_t to NULL.</p>
<p> SYS_MBOX_NULL NULL<br> SYS_SEM_NULL NULL</p>
</blockquote>
<p>å…¶å®å°‘äº†ä¸€ä¸ª sys_mutex_t ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯ FreeRTOSï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ lwip_contrib çš„ ports/freertos çš„ä»£ç ã€‚</p>
<p>lwipopts.h ä½¿ç”¨äº† ESP32 çš„å³å¯ã€‚</p>
</li>
</ol>
<h2 id="LwIP-åˆå§‹åŒ–"><a href="#LwIP-åˆå§‹åŒ–" class="headerlink" title="LwIP åˆå§‹åŒ–"></a>LwIP åˆå§‹åŒ–</h2><p>å‚è€ƒ <a href="resources/LwIP/doc/rawapi.txt">doc/rawapi.txt</a> çš„ System initalization ç« èŠ‚ã€‚ <a href="resources/LwIP/doc/NO_SYS_SampleCode.c">doc/NO_SYS_SampleCode.c</a> æ˜¯ç¤ºä¾‹ä»£ç ã€‚</p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://www.cnblogs.com/byeyear/p/4169834.html">lwipåˆå§‹åŒ–è¿‡ç¨‹</a></p>
<blockquote>
<p>åˆå§‹åŒ–è¿‡ç¨‹çš„å‰åŠéƒ¨åˆ†ä¸»è¦é’ˆå¯¹lwipçš„å†…å­˜ç®¡ç†å’Œå„ä¸ªåè®®å±‚ï¼Œåœ¨src/core/init.cä¸­æœ‰ä¸€ä¸ªlwip_init()å‡½æ•°å·²ç»ä¸ºæˆ‘ä»¬åšå¥½äº†ï¼Œç›´æ¥è°ƒç”¨å³å¯ï¼›</p>
<p>åˆå§‹åŒ–è¿‡ç¨‹çš„ååŠéƒ¨åˆ†åˆå§‹åŒ–ç½‘ç»œæ¥å£ï¼Œä¾æ¬¡è°ƒç”¨ä»¥ä¸‹å‡½æ•°ï¼š</p>
<p>netif_addï¼ˆå¦‚æœæœ‰å¤šä¸ªæ¥å£åˆ™éœ€å¤šæ¬¡è°ƒç”¨ï¼‰</p>
<p>netif_set_default</p>
<p>netif_set_up</p>
<p>dhcp_start</p>
<p>è°ƒç”¨netif_addå‡½æ•°æ—¶æˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªinitå‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬è‡ªå·±çš„ç¡¬ä»¶æ¥å£åˆå§‹åŒ–å‡½æ•°ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯ethernetif.cä¸­çš„ethernetif_init()ã€‚</p>
</blockquote>
<p>å…¶ä¸­ lwip_init å‡½æ•°å†…ä¸»è¦æ˜¯åšå†…å­˜å’Œå˜é‡åˆå§‹åŒ–ã€‚</p>
<p>åœ¨ netif_add å‡½æ•°å†…ä¼šè°ƒç”¨ init å‡½æ•°æŒ‡é’ˆæ¥åˆå§‹åŒ–ç½‘å¡ã€‚LwIP çš„é€»è¾‘æ˜¯è®¤ä¸ºåœ¨æ·»åŠ ç½‘å¡æ—¶å°±åº”è¯¥åˆå§‹åŒ–å®ƒã€‚</p>
<p>LwIP é€šè¿‡ netif_set_link_up è§¦å‘çš„äº‹ä»¶æ¥å¯åŠ¨ DHCP discoveryã€‚</p>
<p>ä½¿ç”¨ OS çš„ LwIP åˆå§‹åŒ–åªæ˜¯æŠŠç¬¬ä¸€æ­¥çš„ lwip_init æ¢æˆäº† tcpip_initã€‚å…¶å® tcpip_init é‡Œä¹Ÿæ˜¯è°ƒç”¨äº† lwip_initï¼Œå¹¶åˆ›å»ºäº† tcpip_threadã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">tcpip_init(tcpip_init_done_fn initfunc, void *arg)</span><br><span class="line">&#123;</span><br><span class="line">  lwip_init();</span><br><span class="line">  tcpip_init_done &#x3D; initfunc;</span><br><span class="line">  tcpip_init_done_arg &#x3D; arg;</span><br><span class="line">  if (sys_mbox_new(&amp;mbox, TCPIP_MBOX_SIZE) !&#x3D; ERR_OK) &#123;</span><br><span class="line">    LWIP_ASSERT(&quot;failed to create tcpip_thread mbox&quot;, 0);</span><br><span class="line">  &#125;</span><br><span class="line">#if LWIP_TCPIP_CORE_LOCKING</span><br><span class="line">  if (sys_mutex_new(&amp;lock_tcpip_core) !&#x3D; ERR_OK) &#123;</span><br><span class="line">    LWIP_ASSERT(&quot;failed to create lock_tcpip_core&quot;, 0);</span><br><span class="line">  &#125;</span><br><span class="line">#endif &#x2F;* LWIP_TCPIP_CORE_LOCKING *&#x2F;</span><br><span class="line">  sys_thread_new(TCPIP_THREAD_NAME, tcpip_thread, NULL, TCPIP_THREAD_STACKSIZE, TCPIP_THREAD_PRIO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="netif-set-link-up-å’Œ-netif-set-up-çš„åŒºåˆ«"><a href="#netif-set-link-up-å’Œ-netif-set-up-çš„åŒºåˆ«" class="headerlink" title="netif_set_link_up å’Œ netif_set_up çš„åŒºåˆ«"></a>netif_set_link_up å’Œ netif_set_up çš„åŒºåˆ«</h2><p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://www.cnblogs.com/byeyear/p/3514573.html">LwIPï¼šå¤„ç†é“¾è·¯çŠ¶æ€æ”¹å˜</a></p>
<p>æ­¤ä½œè€…çš„ LwIP åˆ†ç±»ï¼š<a target="_blank" rel="noopener" href="http://www.cnblogs.com/byeyear/category/513604.html">http://www.cnblogs.com/byeyear/category/513604.html</a></p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://lwip.wikia.com/wiki/Network_interfaces_management">Network interfaces management</a></p>
<p>è¿˜æœ‰ä¸ª WiKiï¼š<a target="_blank" rel="noopener" href="http://lwip.wikia.com/wiki/LwIP_Wiki">lwIP Wiki</a></p>
<p>å®ƒä»¬ä¼¼ä¹éƒ½è®¤ä¸º netif_set_up ä»£è¡¨ç€ç½‘å¡æ‹¿åˆ°äº† IP åœ°å€ï¼Œå¯ä»¥æ”¶å‘æ•°æ®äº†ã€‚</p>
<p>ä½†æ˜¯æ ¹æ®ä½œè€…æœ¬äººå›å¤ï¼š<a target="_blank" rel="noopener" href="http://savannah.nongnu.org/bugs/?func=detailitem&item_id=37068"><em>bug #37068</em>: netif up/down handling is unclear</a></p>
<p>å†æ ¹æ® CHANGELOGï¼š</p>
<blockquote>
<p>  2015-03-05: Simon Goldschmidt</p>
<ul>
<li>netif.c, ip4.c, dhcp.c, autoip.c: fixed bug #37068 (netif up/down handling<br>is unclear): correclty separated administrative status of a netif (up/down)<br>from â€˜valid addressâ€™ status<br>ATTENTION: netif_set_up() now always has to be called, even when dhcp/autoip<br>is used!</li>
</ul>
</blockquote>
<p>å®˜æ–¹è§£é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>This is the administrative (= software) state of the netif, when the netif is fully configured this function must be called.</p>
</blockquote>
<blockquote>
<p>Bring an interface up, available for processing traffic.</p>
</blockquote>
<p>æ‰€ä»¥ï¼š</p>
<p>netif_set_up æ˜¯ä½¿èƒ½ç½‘å¡ï¼Œè®¾ç½® NETIF_FLAG_UP æ ‡å¿—ä½ï¼Œå¿…é¡»åœ¨ç½‘å¡è¢«ä½¿ç”¨å‰ç”¨æˆ·æ¥è°ƒç”¨<br>netif_set_link_up æ˜¯å½“ç½‘å¡é“¾è·¯å±‚ active æ—¶ç”±ç½‘å¡é©±åŠ¨æ¥è®¾ç½®çš„ï¼Œå¦‚ï¼Œstation å…³è”ä¸Š AP åå°±åº”è¯¥è°ƒç”¨netif_set_link_upã€‚</p>
<h2 id="æ³¨å†Œ-DHCP-å›è°ƒå‡½æ•°-netif-set-status-callback"><a href="#æ³¨å†Œ-DHCP-å›è°ƒå‡½æ•°-netif-set-status-callback" class="headerlink" title="æ³¨å†Œ DHCP å›è°ƒå‡½æ•° - netif_set_status_callback()"></a>æ³¨å†Œ DHCP å›è°ƒå‡½æ•° - netif_set_status_callback()</h2><p>ä½¿ç”¨<code>netif_set_status_callback</code>å‡½æ•°å¯ä»¥æ³¨å†Œå›è°ƒå‡½æ•°<code>NETIF_STATUS_CALLBACK</code>ï¼Œé‚£ä¹ˆåè®®æ ˆä¸­ä»€ä¹ˆæ—¶å€™å›è°ƒè¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿ </p>
<ul>
<li><h3 id="NETIF-STATUS-CALLBACK"><a href="#NETIF-STATUS-CALLBACK" class="headerlink" title="NETIF_STATUS_CALLBACK"></a>NETIF_STATUS_CALLBACK</h3></li>
</ul>
<p>æœ‰ 3 ä¸ªå‡½æ•°å†…ä¼šå›è°ƒè¿™ä¸ªå‡½æ•°ï¼Œè¿™ 3 ä¸ªå‡½æ•°å†…ä¼šåˆ¤æ–­ç½‘å¡çŠ¶æ€æœ‰å˜åŒ–æ‰è°ƒç”¨æ­¤å›è°ƒå‡½æ•°(å¦‚ç½‘å¡ä» down åˆ° upï¼Œæˆ–è€…è®¾ç½®äº†æ–°çš„IPåœ°å€)ï¼š</p>
<ol>
<li><code>netif_set_up</code><br>ç”±ç”¨æˆ·è°ƒç”¨ä»¥ä½¿èƒ½ç½‘å¡</li>
<li><code>netif_set_down</code><br>ç”±ç”¨æˆ·è°ƒç”¨ä»¥ç¦æ­¢ç½‘å¡</li>
<li><code>netif_set_ipaddr</code><br>ç”±<code>netif_set_addr</code>è°ƒç”¨ï¼ˆ<code>netif_set_ipaddr</code>è®¾ç½® IP åœ°å€ï¼Œè€Œ<code>netif_set_addr</code>è¿˜è®¾ç½®äº†å­ç½‘æ©ç å’Œç½‘å…³åœ°å€ï¼‰</li>
</ol>
<ul>
<li><h3 id="netif-set-addr"><a href="#netif-set-addr" class="headerlink" title="netif_set_addr"></a>netif_set_addr</h3></li>
</ul>
<p><code>netif_set_addr</code>æœ‰ 4 ä¸ªåœ°æ–¹è°ƒç”¨ï¼š</p>
<ol>
<li>netif ä¸­çš„<code>netif_add</code></li>
<li>dhcp </li>
<li>autoip </li>
<li>ppp </li>
</ol>
<p>autoip å’Œ ppp æ²¡æœ‰ç”¨åˆ°ï¼Œ<code>netif_add</code>æ˜¯åœ¨åˆå§‹åŒ–ç½‘å¡æ—¶è°ƒç”¨çš„ï¼Œæ‰€ä»¥åªç”¨åˆ†æ dhcpã€‚</p>
<p>dhcp ä¸­æœ‰ 3 ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>netif_set_addr</code>ï¼š </p>
<ol>
<li><code>dhcp_handle_nak</code><br>DHCP serveræ”¶åˆ° client çš„ DHCP request åï¼Œå¦‚æœç”±äºæŸäº›åŸå› ä¸èƒ½æ­£å¸¸çš„åˆ†é…IPåœ°å€ï¼Œåˆ™ä¼šå‘é€ NAK ç»™ clientï¼Œè¿™ä¸ª NAK å°±åœ¨<code>dhcp_handle_nak</code>ä¸­å¤„ç†ï¼šé¦–å…ˆè°ƒç”¨<code>netif_set_addr</code>å°†ç½‘å¡çš„åœ°å€æ¢å¤é»˜è®¤çš„<code>IP_ADDR_ANY</code>ï¼Œç„¶åé‡å¯ dhcpã€‚</li>
<li><code>dhcp_bind</code><br>åœ¨ 2 ä¸ªå‡½æ•°å†…è¢«è°ƒç”¨ï¼š <ol>
<li><code>dhcp_recv</code><br>æˆåŠŸæ”¶åˆ° DHCP ACK åï¼Œè‹¥ç½‘å¡ä¸æ”¯æŒ ARPï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨<code>dhcp_bind</code>æ¥ç»‘å®š IP åœ°å€ï¼ŒDHCP å®Œæˆã€‚</li>
<li><code>dhcp_timeout</code><br>è‹¥ç”¨ç½‘å¡æ”¯æŒ ARPï¼Œåˆ™åœ¨<code>dhcp_recv</code>å†…ä¼šå‘åˆ†é…çš„ IP åœ°å€å‘é€ä¸€ä¸ª ARP åŒ…ä»¥æ£€æŸ¥æ˜¯å¦å·²è¢«å…¶ä»–ä¸»æœºä½¿ç”¨ï¼Œè‹¥æ²¡æœ‰æ”¶åˆ° ARP å›å¤ï¼Œåˆ™ 500ms åçš„<code>dhcp_timeout</code>ä¼šè°ƒç”¨<code>dhcp_bind</code>æ¥ç»‘å®š IP åœ°å€ï¼ŒDHCP å®Œæˆã€‚</li>
</ol>
</li>
<li><code>dhcp_release</code><br>é‡Šæ”¾å·²åˆ†é…çš„ IP åœ°å€ï¼Œä¹Ÿä¼šè°ƒç”¨<code>netif_set_addr</code>å°†ç½‘å¡çš„åœ°å€æ¢å¤é»˜è®¤ã€‚</li>
</ol>
<p>æ‰€ä»¥<code>NETIF_STATUS_CALLBACK</code>å¯ä»¥ç”¨ä½œæ˜¯ DHCP ç»“æœçš„ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚</p>
<p>DHCP æœ€åé˜¶æ®µçš„ ACK åŒ…ä¸­å«æœ‰ï¼š</p>
<ul>
<li>Your IP addressï¼šåˆ†é…ç»™æœ¬æœºçš„ IP åœ°å€ã€‚</li>
<li>Subnet Maskï¼šå­ç½‘æ©ç ã€‚</li>
<li>Routerï¼šç½‘å…³ IP åœ°å€ã€‚</li>
<li>Domain Name Serverï¼šDNS æœåŠ¡å™¨ IP åœ°å€ã€‚<br><img src="/Users/snowyang/markdown/resources/LwIP/dhcp_options.png" alt="dhcp_options"></li>
</ul>
<h2 id="Redefination-of-timeval"><a href="#Redefination-of-timeval" class="headerlink" title="Redefination of timeval"></a>Redefination of timeval</h2><p>struct timeval åœ¨ LwIP çš„ socket.h å’Œ GCC çš„ _timeval.h å†…éƒ½æœ‰å®šä¹‰ï¼Œè¿™æ ·åœ¨ç¼–è¯‘æ—¶å°±ä¼šå‡ºé”™ã€‚</p>
<p>æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li><p>ä½¿ç”¨ GCC çš„ timevalï¼šåœ¨ lwipopts.h å®šä¹‰ LWIP_TIMEVAL_PRIVATE ä¸º 0ï¼Œå¹¶åœ¨ cc.h å†…åŒ…å«å¤´æ–‡ä»¶ &lt;sys/time.h&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** LWIP_TIMEVAL_PRIVATE: if you want to use the struct timeval provided</span><br><span class="line"> * by your system, set this to 0 and include &lt;sys&#x2F;time.h&gt; in cc.h *&#x2F;</span><br><span class="line">#ifndef LWIP_TIMEVAL_PRIVATE</span><br><span class="line">#define LWIP_TIMEVAL_PRIVATE 1</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if LWIP_TIMEVAL_PRIVATE</span><br><span class="line">struct timeval &#123;</span><br><span class="line">  long    tv_sec;         &#x2F;* seconds *&#x2F;</span><br><span class="line">  long    tv_usec;        &#x2F;* and microseconds *&#x2F;</span><br><span class="line">&#125;;</span><br><span class="line">#endif &#x2F;* LWIP_TIMEVAL_PRIVATE *&#x2F;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨ LwIP çš„ timevalï¼šåŠ å…¥å…¨å±€ç¼–è¯‘é€‰é¡¹<code>-D_TIMEVAL_DEFINED</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#ifndef _TIMEVAL_DEFINED</span><br><span class="line">#define _TIMEVAL_DEFINED</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * Structure returned by gettimeofday(2) system call, and used in other calls.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct timeval &#123;</span><br><span class="line">	time_t		tv_sec;		&#x2F;* seconds *&#x2F;</span><br><span class="line">	suseconds_t	tv_usec;	&#x2F;* and microseconds *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="DNS-ç¼“å­˜é—®é¢˜"><a href="#DNS-ç¼“å­˜é—®é¢˜" class="headerlink" title="DNS ç¼“å­˜é—®é¢˜"></a>DNS ç¼“å­˜é—®é¢˜</h2></li>
</ul>
<p>ä¸»æœºåœ¨æ”¶åˆ° DNS response åä¼šå°† <Domain : IP> å­˜å‚¨åˆ° DNS cache å†…ï¼Œä¸‹æ¬¡å¯å¿«é€Ÿæä¾›ç»™åº”ç”¨å±‚ã€‚</p>
<p>å½“è·¯ç”±å™¨æ²¡æœ‰å¤–ç½‘æ—¶ï¼Œå¯¹äºä¸»æœºçš„ DNS queryï¼Œä¸€èˆ¬çš„è·¯ç”±å™¨æ˜¯ä¸äºˆç†ä¼šï¼Œé‚£ä¹ˆä¸»æœºè‡ªç„¶ä¼šè¶…æ—¶å¤±è´¥ï¼Œä½†æœ‰äº›è·¯ç”±å™¨ä¼šå›å¤ä¸€ä¸ªè‡ªå·± IP çš„ DNS responseï¼Œé‚£ä¹ˆä¸»æœºå°±è®¤ä¸º DNS æˆåŠŸäº†ï¼Œç”¨è¿™ä¸ª IP å»å»ºç«‹ HTTPS è¿æ¥å°±ä¼šå¤±è´¥ã€‚</p>
<p>ä¸€èˆ¬åœ¨ HTTPS è¿æ¥å¤±è´¥åï¼Œä¸»æœºä¼šå†æ¬¡å»æŸ¥è¯¢ DNSï¼Œå³ä½¿æ­¤æ—¶è·¯ç”±å™¨çš„å¤–ç½‘å»ºç«‹äº†è¿æ¥ï¼Œä½†ç”±äº DNS ç¼“å­˜çš„å­˜åœ¨ï¼ˆæ­¤æ‰€ä»¥ä¸»æœºä¸ä¼šå‘ DNS queryï¼‰ï¼Œå¯¼è‡´å¾—åˆ°çš„è¿˜æ˜¯è·¯ç”±å™¨çš„ IPï¼Œæ‰€ä»¥ä¼š HTTPS è¿æ¥å¤±è´¥ã€‚åªèƒ½ç­‰åˆ° DNS ç¼“å­˜è¿‡æœŸä¸»æœºä¼šå‘å‡º DNS queryï¼Œæ‰èƒ½å¾—åˆ°æ­£ç¡®çš„ IP åœ°å€ ã€‚</p>
<p>æœ‰ä¸‰ç§æ–¹æ³•æ¥è§£å†³æ­¤é—®é¢˜ï¼š</p>
<ul>
<li>åœ¨ dns_gethostbyname å†…å±è”½ dns_lookupï¼Œå³ä¸è¦æŸ¥è¯¢ DNS ç¼“å­˜ã€‚</li>
<li>åœ¨è°ƒç”¨ gethostbyname å‰è°ƒç”¨ dns_clean ä»¥æ¸…é™¤ DNS ç¼“å­˜ã€‚</li>
<li>æŠŠ DNS_MAX_TTL è®¾ç½®ä¸º 1ï¼ˆç§’ï¼‰ï¼ŒDNS_MAX_TTL å³ä¸º DNS ç¼“å­˜çš„æœ€å¤§æ—¶é—´ã€‚æ¨èæ­¤æ–¹æ³•ï¼Œæ”¹åŠ¨æœ€å°ã€‚</li>
</ul>
<h2 id="DNS-è¿”å›å¤šä¸ªåœ°å€"><a href="#DNS-è¿”å›å¤šä¸ªåœ°å€" class="headerlink" title="DNS è¿”å›å¤šä¸ªåœ°å€"></a>DNS è¿”å›å¤šä¸ªåœ°å€</h2><p>LwIP ä¸­çš„ DNS åªè¿”å›ä¸€ä¸ªåœ°å€ï¼Œå¯¹äºä¸€äº›å¼€å¯äº†è´Ÿè½½å‡è¡¡çš„æœåŠ¡å™¨å°±æœ‰å¯èƒ½è¿ä¸ä¸Šã€‚</p>
<h2 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h2><h3 id="æ³¨å†Œ-DHCP-å›è°ƒå‡½æ•°"><a href="#æ³¨å†Œ-DHCP-å›è°ƒå‡½æ•°" class="headerlink" title="æ³¨å†Œ DHCP å›è°ƒå‡½æ•°"></a>æ³¨å†Œ DHCP å›è°ƒå‡½æ•°</h3><p>ä½¿ç”¨<code>netif_set_status_callback</code>å‡½æ•°å¯ä»¥æ³¨å†Œå›è°ƒå‡½æ•°<code>NETIF_STATUS_CALLBACK</code>ï¼Œé‚£ä¹ˆåè®®æ ˆä¸­ä»€ä¹ˆæ—¶å€™å›è°ƒè¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿ </p>
<p><strong>NETIF_STATUS_CALLBACK</strong></p>
<p>æœ‰ 3 ä¸ªå‡½æ•°å†…ä¼šå›è°ƒè¿™ä¸ªå‡½æ•°ï¼Œè¿™ 3 ä¸ªå‡½æ•°å†…ä¼šåˆ¤æ–­ç½‘å¡çŠ¶æ€æœ‰å˜åŒ–æ‰è°ƒç”¨æ­¤å›è°ƒå‡½æ•°(å¦‚ç½‘å¡ä» down åˆ° upï¼Œæˆ–è€…è®¾ç½®äº†æ–°çš„IPåœ°å€)ï¼š</p>
<ol>
<li><p><code>netif_set_up</code><br> ç”±ç”¨æˆ·è°ƒç”¨ä»¥ä½¿èƒ½ç½‘å¡</p>
</li>
<li><p><code>netif_set_down</code><br> ç”±ç”¨æˆ·è°ƒç”¨ä»¥ç¦æ­¢ç½‘å¡</p>
</li>
<li><p><code>netif_set_ipaddr</code><br> ç”±<code>netif_set_addr</code>è°ƒç”¨ï¼ˆ<code>netif_set_ipaddr</code>è®¾ç½® IP åœ°å€ï¼Œè€Œ<code>netif_set_addr</code>è¿˜è®¾ç½®äº†å­ç½‘æ©ç å’Œç½‘å…³åœ°å€ï¼‰</p>
</li>
</ol>
<p><strong>netif_set_addr</strong></p>
<p><code>netif_set_addr</code>æœ‰ 4 ä¸ªåœ°æ–¹è°ƒç”¨ï¼š</p>
<ol>
<li>netif ä¸­çš„<code>netif_add</code></li>
<li>dhcp </li>
<li>autoip </li>
<li>ppp </li>
</ol>
<p>autoip å’Œ ppp æ²¡æœ‰ç”¨åˆ°ï¼Œ<code>netif_add</code>æ˜¯åœ¨åˆå§‹åŒ–ç½‘å¡æ—¶è°ƒç”¨çš„ï¼Œæ‰€ä»¥åªç”¨åˆ†æ dhcpã€‚</p>
<p>dhcp ä¸­æœ‰ 3 ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>netif_set_addr</code>ï¼š </p>
<ol>
<li><p><code>dhcp_handle_nak</code><br> DHCP serveræ”¶åˆ° client çš„ DHCP request åï¼Œå¦‚æœç”±äºæŸäº›åŸå› ä¸èƒ½æ­£å¸¸çš„åˆ†é…IPåœ°å€ï¼Œåˆ™ä¼šå‘é€ NAK ç»™ clientï¼Œè¿™ä¸ª NAK å°±åœ¨<code>dhcp_handle_nak</code>ä¸­å¤„ç†ï¼šé¦–å…ˆè°ƒç”¨<code>netif_set_addr</code>å°†ç½‘å¡çš„åœ°å€æ¢å¤é»˜è®¤çš„<code>IP_ADDR_ANY</code>ï¼Œç„¶åé‡å¯ dhcpã€‚</p>
</li>
<li><p><code>dhcp_bind</code><br> åœ¨ 2 ä¸ªå‡½æ•°å†…è¢«è°ƒç”¨ï¼š </p>
</li>
<li><p><code>dhcp_recv</code>  </p>
<p>æˆåŠŸæ”¶åˆ° DHCP ACK åï¼Œè‹¥ç½‘å¡ä¸æ”¯æŒ ARPï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨<code>dhcp_bind</code>æ¥ç»‘å®š IP åœ°å€ï¼ŒDHCP å®Œæˆã€‚</p>
</li>
<li><p><code>dhcp_timeout</code>  </p>
<p>è‹¥ç”¨ç½‘å¡æ”¯æŒ ARPï¼Œåˆ™åœ¨<code>dhcp_recv</code>å†…ä¼šå‘åˆ†é…çš„ IP åœ°å€å‘é€ä¸€ä¸ª ARP åŒ…ä»¥æ£€æŸ¥æ˜¯å¦å·²è¢«å…¶ä»–ä¸»æœºä½¿ç”¨ï¼Œè‹¥æ²¡æœ‰æ”¶åˆ° ARP å›å¤ï¼Œåˆ™ 500ms åçš„<code>dhcp_timeout</code>ä¼šè°ƒç”¨<code>dhcp_bind</code>æ¥ç»‘å®š IP åœ°å€ï¼ŒDHCP å®Œæˆã€‚</p>
</li>
<li><p><code>dhcp_release</code><br> é‡Šæ”¾å·²åˆ†é…çš„ IP åœ°å€ï¼Œä¹Ÿä¼šè°ƒç”¨<code>netif_set_addr</code>å°†ç½‘å¡çš„åœ°å€æ¢å¤é»˜è®¤ã€‚</p>
</li>
</ol>
<p>æ‰€ä»¥<code>NETIF_STATUS_CALLBACK</code>å¯ä»¥ç”¨ä½œæ˜¯ DHCP ç»“æœçš„ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚</p>
<p>DHCP æœ€åé˜¶æ®µçš„ ACK åŒ…ä¸­å«æœ‰ï¼š</p>
<ul>
<li>Your IP addressï¼šåˆ†é…ç»™æœ¬æœºçš„ IP åœ°å€ã€‚</li>
<li>Subnet Maskï¼šå­ç½‘æ©ç ã€‚</li>
<li>Routerï¼šç½‘å…³ IP åœ°å€ã€‚</li>
<li>Domain Name Serverï¼šDNS æœåŠ¡å™¨ IP åœ°å€ã€‚</li>
</ul>
<h3 id="å¯åŠ¨-DHCP-dhcp-start"><a href="#å¯åŠ¨-DHCP-dhcp-start" class="headerlink" title="å¯åŠ¨ DHCP - dhcp_start"></a>å¯åŠ¨ DHCP - dhcp_start</h3><p><code>dhcp_start</code>ä¼šæ£€æŸ¥å½“å‰ç½‘å¡çš„é“¾è·¯æ˜¯å¦activeï¼Œè‹¥æ˜¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨<code>dhcp_discovery</code>ï¼Œå¦åˆ™ï¼Œè®¾ç½® dhcp çš„ state ä¸º<code>INIT</code>ã€‚</p>
<p>ç½‘å¡é©±åŠ¨ä¸­åº”è¯¥åœ¨ç½‘å¡ link up åï¼ˆå¦‚ Wi-Fi ç½‘ç»œä¸­ station è¿æ¥ä¸Š AP) è°ƒç”¨<code>netif_set_link_up</code>ï¼Œ<code>netif_set_link_up</code>å†…ä¼šè°ƒç”¨<code>dhcp_network_changed</code>ï¼Œ<code>dhcp_network_changed</code>å†…å‘ç°å½“å‰ DHCP çŠ¶æ€ä¸º<code>INIT</code>æ—¶å°±è°ƒç”¨<code>dhcp_discovery</code>ï¼Œä»è€Œå‘èµ· discoveryã€‚</p>
<p>æ‰€ä»¥å¯ä»¥åœ¨ç½‘å¡ link up å‰å°±è°ƒç”¨<code>dhcp_start</code>ã€‚</p>
<h3 id="DHCP-åŠ é€Ÿ"><a href="#DHCP-åŠ é€Ÿ" class="headerlink" title="DHCP åŠ é€Ÿ"></a>DHCP åŠ é€Ÿ</h3><p>æœ‰æ—¶å€™è¿ç½‘ä¼šå¾ˆæ…¢ï¼ŒæŠ“åŒ…æ¥çœ‹æ˜¯ DHCP èŠ±è´¹äº†å¾ˆé•¿æ—¶é—´ï¼Œç©¶å…¶åŸå› ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p>
<ol>
<li>ä¸¢åŒ…ï¼Œç‰¹åˆ«æ˜¯ Wi-Fi ã€‚</li>
<li>ä¸€äº›è·¯ç”±å™¨æ˜¯å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä¼šæ‹’ç»è®¾å¤‡çš„å†æ¬¡è¯·æ±‚ã€‚</li>
</ol>
<p>ä»¥ä¸Šä¸¤ç§åŸå› çš„ç»“æœéƒ½æ˜¯è¶…æ—¶é‡ä¼ ï¼Œåœ¨ LwIP ä¸­ DHCP çš„è¶…æ—¶é‡ä¼ æ—¶é—´æ˜¯ 2sï¼Œ4sï¼Œ8s â€¦ï¼Œä»¥ 2 çš„æŒ‡æ•°å€å¢é•¿ï¼Œæ‰€ä»¥ä¸€æ—¦å‘ç”Ÿè¶…æ—¶é‡ä¼ ï¼Œå°±ä¼šå¾ˆæ…¢ã€‚</p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ŒDHCP ç”±ä¸€ä¸ª 500ms çš„ fine timer æ¥å¤„ç†è¶…æ—¶äº‹ä»¶ï¼Œé‚£ä¹ˆå°†æ‰€æœ‰çš„ DHCP è¶…æ—¶é‡ä¼ é—´éš”è®¾ç½®ä¸º 500ms å³å¯å¤§å¤§åŠ å¿« DHCP çš„é€Ÿåº¦ã€‚</p>
<p>ç»è¿‡æµ‹è¯•ï¼Œåœ¨æœªä¼˜åŒ–ä¹‹å‰ï¼ŒDHCP å¹³å‡éœ€è¦çº¦ 4s çš„æ—¶é—´ï¼Œä¼˜åŒ–ååªéœ€ 2s çš„æ—¶é—´ã€‚</p>
<h2 id="æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚ç§»æ¤"><a href="#æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚ç§»æ¤" class="headerlink" title="æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚ç§»æ¤"></a>æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚ç§»æ¤</h2><p>ç§»æ¤æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å®ç°å‡ ä¸ªæ“ä½œç³»ç»Ÿæ¥å£å‡½æ•°ï¼šä¿¡å·é‡ï¼Œé‚®ç®±ï¼Œäº’æ–¥é‡å’Œçº¿ç¨‹ã€‚ </p>
<p>ä¿¡å·é‡ï¼Œé‚®ç®±å’Œäº’æ–¥é‡çš„æ“ä½œï¼š</p>
<ul>
<li>new</li>
<li>free</li>
<li>write</li>
<li>read</li>
</ul>
<p>ä¿¡å·é‡å’Œé‚®ç®±è¿˜æœ‰é¢å¤–çš„å››ä¸ªæ“ä½œï¼š</p>
<ul>
<li>try_write</li>
<li>try_read</li>
<li>valid</li>
<li>invalid </li>
</ul>
<p>çº¿ç¨‹çš„æ“ä½œï¼š</p>
<ul>
<li>new</li>
</ul>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><h3 id="LwIP-ä¸­çš„-ACK"><a href="#LwIP-ä¸­çš„-ACK" class="headerlink" title="LwIP ä¸­çš„ ACK"></a>LwIP ä¸­çš„ ACK</h3><p>åœ¨<code>tcp_receive</code>å†…ä¼šè°ƒç”¨<code>tcp_ack</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#define tcp_ack(pcb)                               \</span><br><span class="line">  do &#123;                                             \</span><br><span class="line">    if((pcb)-&gt;flags &amp; TF_ACK_DELAY) &#123;              \</span><br><span class="line">      (pcb)-&gt;flags &amp;&#x3D; ~TF_ACK_DELAY;               \</span><br><span class="line">      (pcb)-&gt;flags |&#x3D; TF_ACK_NOW;                  \</span><br><span class="line">    &#125;                                              \</span><br><span class="line">    else &#123;                                         \</span><br><span class="line">      (pcb)-&gt;flags |&#x3D; TF_ACK_DELAY;                \</span><br><span class="line">    &#125;                                              \</span><br><span class="line">  &#125; while (0)</span><br></pre></td></tr></table></figure>

<p>æ”¶åˆ°ç¬¬ä¸€ä¸ªæ•°æ®åï¼Œä¼šç½®ä½<code>TF_ACK_DELAY</code>ã€‚</p>
<p>åœ¨ 250 ms ä¸€æ¬¡çš„<code>tcp_fasttmr</code>å†…ï¼Œè‹¥å‘ç°<code>TF_ACK_DELAY</code>ä»ç„¶å¤„äºç½®ä½çŠ¶æ€ï¼Œå°±è¯´æ˜æ²¡æœ‰æå¸¦ç¡®è®¤æˆ–ç´¯è®¡ç¡®è®¤ï¼Œé‚£å¿…é¡»åœ¨è¿™é‡Œå‘é€ ACK å‡ºå»ã€‚</p>
<h3 id="ç´¯è®¡ç¡®è®¤"><a href="#ç´¯è®¡ç¡®è®¤" class="headerlink" title="ç´¯è®¡ç¡®è®¤"></a>ç´¯è®¡ç¡®è®¤</h3><p>æ”¶åˆ°ç¬¬äºŒä¸ªæ•°æ®åï¼Œä¼šç½®ä½<code>TF_ACK_NOW</code>å¹¶æ¸…é›¶<code>TF_ACK_DELAY</code>ã€‚</p>
<p>åœ¨<code>tcp_input</code>çš„æœ€åä¼šè°ƒç”¨<code>tcp_output</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">err_t</span><br><span class="line">tcp_output(struct tcp_pcb *pcb)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  if (pcb-&gt;flags &amp; TF_ACK_NOW &amp;&amp;</span><br><span class="line">     (seg &#x3D;&#x3D; NULL ||</span><br><span class="line">      lwip_ntohl(seg-&gt;tcphdr-&gt;seqno) - pcb-&gt;lastack + seg-&gt;len &gt; wnd)) &#123;</span><br><span class="line">     return tcp_send_empty_ack(pcb);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‹¥<code>TF_ACK_NOW</code>è¢«ç½®ä½ï¼Œè¯´æ˜è‡³å°‘æ”¶åˆ°å·²ç»ä¸¤ä¸ªæ•°æ®åŒ…äº†ï¼Œåˆ™ç«‹å³å‘é€ ACKï¼Œè¿™å°±å®ç°äº†ç´¯è®¡ç¡®è®¤çš„åŠŸèƒ½ã€‚</p>
<h3 id="æå¸¦ç¡®è®¤"><a href="#æå¸¦ç¡®è®¤" class="headerlink" title="æå¸¦ç¡®è®¤"></a>æå¸¦ç¡®è®¤</h3><p>åœ¨<code>tcp_output</code>å‘é€æ•°æ®æŠ¥æ—¶ï¼Œä¼šå¡«å…… TCP å¤´çš„ ACK åŸŸï¼Œå¹¶å°†<code>TF_ACK_DELAY</code>å’Œ<code>TF_ACK_NOW</code>æ¸…é›¶ã€‚</p>
<h2 id="LwIP-å°½é‡å‡å°åŠŸèƒ½ä¹‹é—´çš„è€¦åˆæ€§"><a href="#LwIP-å°½é‡å‡å°åŠŸèƒ½ä¹‹é—´çš„è€¦åˆæ€§" class="headerlink" title="LwIP å°½é‡å‡å°åŠŸèƒ½ä¹‹é—´çš„è€¦åˆæ€§"></a>LwIP å°½é‡å‡å°åŠŸèƒ½ä¹‹é—´çš„è€¦åˆæ€§</h2><p>æ¯”å¦‚ï¼Œå»¶æ—¶ç¡®è®¤çš„ 250ms è¶…æ—¶åœ¨<code>tcp_fasttmr</code>å†…å¤„ç†ï¼Œå®ƒåªçœ‹<code>TF_ACK_DELAY</code>æ˜¯å¦è¢«ç½®ä½ï¼Œç½®ä½åˆ™è¯´æ˜å»¶æ—¶ç¡®è®¤è¶…æ—¶ï¼Œéœ€è¦é©¬ä¸Šå‘é€ ACKã€‚</p>
<p>é‚£ä¹ˆå®ƒå’Œå…¶ä»–åŠŸèƒ½æ¨¡å—ä¹‹é—´çš„å”¯ä¸€è€¦åˆå°±æ˜¯<code>TF_ACK_DELAY</code>è¿™ä¸ª flagã€‚åœ¨<code>tcp_receive</code>å†…åªéœ€å°†<code>TF_ACK_DELAY</code>ç½®ä½å³å¯ï¼Œåœ¨æå¸¦ç¡®è®¤æˆ–è€…ç´¯è®¡ç¡®è®¤å†…ä¹Ÿåªéœ€å°†<code>TF_ACK_DELAY</code>æ¸…é›¶å³å¯ã€‚</p>
<p>åœ¨ LwIP ä¸­ï¼Œç‰¹åˆ«æ˜¯è¿™ç§åè®®è¶…æ—¶ï¼Œæ™®éä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p>
<h2 id="LwIP-ä¸­çš„æ—¥å¿—è¾“å‡º"><a href="#LwIP-ä¸­çš„æ—¥å¿—è¾“å‡º" class="headerlink" title="LwIP ä¸­çš„æ—¥å¿—è¾“å‡º"></a>LwIP ä¸­çš„æ—¥å¿—è¾“å‡º</h2><p>LwIP ä½¿ç”¨<code>LWIP_DEBUGF</code>å®æ¥è¾“å‡ºæ—¥å¿—ï¼Œæœ‰ 2 ä¸ªå‚æ•°ï¼š<code>debug</code>å’Œ<code>message</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#define LWIP_DEBUGF(debug, message) do &#123; \</span><br><span class="line">    if ( \</span><br><span class="line">        ((debug) &amp; LWIP_DBG_ON) &amp;&amp; \</span><br><span class="line">        ((debug) &amp; LWIP_DBG_TYPES_ON) &amp;&amp; \</span><br><span class="line">        ((s16_t)((debug) &amp; LWIP_DBG_MASK_LEVEL) &gt;&#x3D; LWIP_DBG_MIN_LEVEL)) &#123; \</span><br><span class="line">      LWIP_PLATFORM_DIAG(message); \</span><br><span class="line">      if ((debug) &amp; LWIP_DBG_HALT) &#123; \</span><br><span class="line">        while(1); \</span><br><span class="line">      &#125; \</span><br><span class="line">    &#125; \</span><br><span class="line">  &#125; while(0)</span><br></pre></td></tr></table></figure>


<p><code>debug</code>å‚æ•°çš„å€¼æ˜¯æ¨¡å—ï¼Œç±»å‹å’Œç­‰çº§çš„ç»„åˆï¼Œè¿™ä¸‰ç§æ˜¯ä¸çš„å…³ç³»ï¼Œå¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LWIP_DEBUGF(DHCP_DEBUG | LWIP_DBG_TRACE | LWIP_DBG_LEVEL_WARNING, </span><br><span class="line">(&quot;dhcp_check: could not perform ARP query\n&quot;));</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<code>debug</code>çš„æ¨¡å—æ˜¯<code>DHCP</code>ï¼Œç±»å‹æ˜¯<code>trace</code>ï¼Œç­‰çº§æ˜¯<code>warning</code>ã€‚  </p>
<p>ç”¨æˆ·å¯ä»¥åœ¨<code>lwipopts.h</code>ä¸­é…ç½®æ—¥å¿—è¾“å‡ºï¼š  </p>
<ul>
<li>å®šä¹‰<code>LWIP_DBG_OFF</code>æ¥å¼€å¯æŸä¸ªæ¨¡å—çš„æ—¥å¿—è¾“å‡º  </li>
<li>å®šä¹‰<code>LWIP_DBG_TYPES_ON</code>æ¥å¼€å¯æŸä¸ªç±»å‹çš„æ—¥å¿—è¾“å‡º  </li>
<li>å®šä¹‰<code>LWIP_DBG_MIN_LEVEL</code>æ¥å¼€å¯æŸä¸ªç­‰çº§çš„æ—¥å¿—è¾“å‡º  </li>
</ul>
<h2 id="LwIP-ä¸­çš„åè®®æ§åˆ¶å—"><a href="#LwIP-ä¸­çš„åè®®æ§åˆ¶å—" class="headerlink" title="LwIP ä¸­çš„åè®®æ§åˆ¶å—"></a>LwIP ä¸­çš„åè®®æ§åˆ¶å—</h2><p><code>PCB</code>å…¨ç§°æ˜¯<code>Protocol Control Block</code>ï¼Œå³<code>åè®®æ§åˆ¶å—</code>ï¼ŒåŒ…å«ç€ä¸€ä¸ªè¿æ¥çš„å±æ€§å’Œæ–¹æ³•ã€‚</p>
<p>ä¸€ä¸ªæ§åˆ¶å—ä»£è¡¨ç€ç€ä¸€ä¸ªåè®®å±‚çš„ä¸€ä¸ªå®ä½“çš„å±æ€§ã€‚</p>
<ul>
<li><p>ç”¨æˆ·æ§åˆ¶å— - netconnï¼Œä¸»è¦å±æ€§æœ‰ï¼š</p>
<ul>
<li>xxx_pcb</li>
<li>åŒæ­¥ä¿¡å·é‡</li>
<li>æ•°æ®é‚®ç®±ï¼Œä»£è¡¨ç€ä¸€ä¸ªç”¨æˆ·å±‚æ¬¡çš„ä¼ è¾“å±‚è¿æ¥ </li>
</ul>
</li>
<li><p>ä¼ è¾“å±‚æ§åˆ¶å— - xxx_pcbï¼Œä»£è¡¨ç€ä¸€ä¸ªå†…æ ¸å±‚æ¬¡çš„ä¼ è¾“å±‚è¿æ¥,ä¸»è¦å±æ€§æœ‰ï¼š  </p>
<ul>
<li>æº/ç›® IP åœ°å€å’Œç«¯å£</li>
<li>å›è°ƒå‡½æ•°å’Œå‚æ•° </li>
</ul>
</li>
<li><p>ç½‘å¡æ§åˆ¶å— - netifï¼Œä»£è¡¨ç€ä¸€ä¸ªç½‘å¡ï¼Œä¸»è¦å±æ€§æœ‰ï¼š  </p>
<ul>
<li>MAC åœ°å€</li>
<li>IP åœ°å€ï¼Œå­ç½‘æ©ç å’Œç½‘å…³åœ°å€</li>
<li>è¾“å…¥/è¾“å‡ºå‡½æ•°</li>
</ul>
</li>
</ul>
<p>ç½‘ç»œå±‚çš„ä½œç”¨æ˜¯å¯»å€å’Œè·¯ç”±ï¼Œæ˜¯ä¸ªä¸­é—´å±‚ï¼Œæ‰€ä»¥æ²¡æœ‰å¯¹åº”çš„æ§åˆ¶å—ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼Œå¤šä¸ª UDP æ§åˆ¶å—ç»„ç»‡æˆä¸€ä¸ªé“¾è¡¨ï¼Œåè®®æ ˆåœ¨æ”¶åˆ°ä¸€ä¸ª UDP åŒ…åä¼šéå†è¿™ä¸ªé“¾è¡¨æŸ¥æ‰¾åŒ¹é…çš„æ§åˆ¶å—ï¼Œç„¶åè°ƒç”¨å…¶æ¥æ”¶å›è°ƒå‡½æ•°ï¼ˆç”¨æˆ·ä¹Ÿå¯ä»¥æ³¨å†Œï¼‰ã€‚</p>
<p><img src="/../resources/TCP:IP/%5Blwip%5D-udp_pcb.jpg" alt="lwip-udp_pcb"></p>
<h2 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h2><p>LwIP è‡ªå¸¦ä¸¤ç§å†…å­˜ç®¡ç†æœºåˆ¶ï¼šå†…å­˜å †(heap)å’Œå†…å­˜æ± (pool)ã€‚</p>
<p>å †å’Œæ± å„è‡ªçš„ä¼˜ç¼ºç‚¹ä¸å†é˜è¿°ï¼Œå…¶å®å°±æ˜¯æ•ˆç‡å’Œåˆ©ç”¨ç‡ä¹‹é—´çš„æƒè¡¡ã€‚</p>
<h3 id="å†…å­˜æ± "><a href="#å†…å­˜æ± " class="headerlink" title="å†…å­˜æ± "></a>å†…å­˜æ± </h3><p>Pool æ˜¯ä¸ªé“¾è¡¨ç»“æ„ï¼ŒLwIP ä¸­æ¯ç§ç±»å‹çš„æ•°æ®ç»“æ„éƒ½å¯¹åº”ç€ä¸€ç§ poolï¼Œåè®®æ ˆç”¨ 5 ä¸ªå±æ€§æ¥æè¿°ä¸€ç§ poolï¼š</p>
<ol>
<li>åç§°å­—ç¬¦</li>
<li>å•ä¸ªå¤§å°</li>
<li>æ€»å…±ä¸ªæ•°</li>
<li>å†…å­˜ç©ºé—´</li>
<li>é¦–æŒ‡é’ˆ</li>
</ol>
<p>ç”¨ç»“æ„ä½“æ¥æè¿°å°±æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct memp_desc</span><br><span class="line">&#123;</span><br><span class="line">  char *desc;</span><br><span class="line">  int size;</span><br><span class="line">  int num;</span><br><span class="line">  int *mem_base;</span><br><span class="line">  memp *tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯ç±» pool éƒ½å¯¹åº”ä¸€ä¸ªç»“æ„ä½“å˜é‡ï¼Œä»€ä¹ˆæ—¶å€™ç”¨ä»€ä¹ˆæ–¹æ³•åˆå§‹åŒ–è¿™äº›ç»“æ„ä½“å˜é‡å‘¢ï¼Ÿ</p>
<p>æ™®é€šçš„åšæ³•æ˜¯ä¸ºæ¯ç±» pool å®šä¹‰ä¸€ä¸ªå˜é‡å¹¶èµ‹åˆå€¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">memp_desc memp_RAW_PCB &#x3D; </span><br><span class="line">&#123;</span><br><span class="line">  &quot;RAW_PCB&quot;,</span><br><span class="line">  1024,</span><br><span class="line">  16,</span><br><span class="line">  0x20001234;</span><br><span class="line">  &amp;memp_tab_RAW_PCB;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯åè®®æ ˆä¸­æœ‰é‚£ä¹ˆå¤šçš„ poolï¼Œè¿™æ ·å¾ˆç¹çä¸”ä¸çµæ´»ã€‚</p>
<p>LwIP ä½¿ç”¨äº†ä¸€ç§å±Œç‚¸å¤©çš„å¥‡æŠ€æ·«å·§ï¼šå®å®šä¹‰å¤§æ³•ã€‚</p>
<p>åè®®æ ˆçš„ memp_std.h ä¸­ä¸ºæ¯ç±» pool å®šä¹‰äº†ä¸€è¡Œå­—ç¬¦ä¸²ï¼šLWIP_MEMPOOL(name, num, size, desc)ï¼Œè¿™è¡Œå­—ç¬¦ä¸²ç”¨æ¥æè¿°ä¸€ç±» pool çš„å±æ€§ã€‚</p>
<p>ä¾‹å¦‚ï¼šLWIP_MEMPOOL(RAW_PCB,        MEMP_NUM_RAW_PCB,         sizeof(struct raw_pcb),        â€œRAW_PCBâ€)</p>
<p>ç„¶ååœ¨ memp.c ä¸­æŠŠ LWIP_MEMPOOL å®šä¹‰æˆäº†ä¸€ä¸ªå±Œç‚¸å¤©çš„å®å®šä¹‰ï¼ˆç•¥æœ‰ä¿®æ”¹ï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#define LWIP_MEMPOOL_DECLARE(name,num,size,desc) \</span><br><span class="line">  u8_t memp_memory_ ## name ## _base[num * size]; \</span><br><span class="line">  static struct memp *memp_tab_ ## name; \</span><br><span class="line">  const struct memp_desc memp_ ## name &#x3D; \</span><br><span class="line">  &#123; \</span><br><span class="line">    desc, \</span><br><span class="line">    size, \</span><br><span class="line">    num, \</span><br><span class="line">    memp_memory_ ## name ## _base, \</span><br><span class="line">    &amp;memp_tab_ ## name \</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å±•å¼€åæ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">u8_t memp_memory_RAW_PCB_base[MEMP_NUM_RAW_PCB * sizeof(struct raw_pcb)];</span><br><span class="line">static struct memp *memp_tab_RAW_PCB;</span><br><span class="line">const struct memp_desc memp_RAW_PCB &#x3D;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;RAW_PCB&quot;,</span><br><span class="line">  sizeof(struct raw_pcb),</span><br><span class="line">  MEMP_NUM_RAW_PCB,</span><br><span class="line">  memp_memory_RAW_PCB_base,</span><br><span class="line">  &amp;memp_tab_RAW_PCB</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å°±é—®ä½ å±Œä¸å±Œï¼ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜</p>
<p>==<strong>åªè¦ä»£ç ä¸­æœ‰å®šä¹‰å¤šä¸ªç›¸åŒç»“æ„ä½“ç±»å‹çš„å˜é‡çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼æ¥ç®€åŒ–ä»£ç ã€‚</strong>==</p>
<p>MEMP ç±»å‹å¤§å…¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">RAW_PCB</span><br><span class="line">UDP_PCB</span><br><span class="line">TCP_PCB</span><br><span class="line">TCP_PCB_LISTEN</span><br><span class="line">TCP_SEG</span><br><span class="line">REASSDATA</span><br><span class="line">FRAG_PBUF</span><br><span class="line">NETBUF</span><br><span class="line">NETCONN</span><br><span class="line">TCPIP_MSG_API</span><br><span class="line">API_MSG</span><br><span class="line">DNS_API_MSG</span><br><span class="line">SOCKET_SETGETSOCKOPT_DATA</span><br><span class="line">NETIFAPI_MSG</span><br><span class="line">TCPIP_MSG_INPKT</span><br><span class="line">ARP_QUEUE</span><br><span class="line">IGMP_GROUP</span><br><span class="line">SYS_TIMEOUT</span><br><span class="line">NETDB</span><br><span class="line">LOCALHOSTLIST</span><br><span class="line">ND6_QUEUE</span><br><span class="line">IP6_REASSDATA</span><br><span class="line">MLD6_GROUP</span><br><span class="line">PBUF</span><br><span class="line">PBUF_POOL</span><br></pre></td></tr></table></figure>
<p><strong>PBUF POOL</strong></p>
<p>PBUF POOLæ˜¯ç”¨åœ¨ç½‘ç»œæ¥å£å±‚å­˜å‚¨æ¥æ”¶åˆ°çš„æ•°æ®çš„ poolï¼Œä¸€èˆ¬å¤§å°ä¸º pbuf struct + TCP_MSS + IP header + link headerã€‚</p>
<h3 id="å†…å­˜å †"><a href="#å†…å­˜å †" class="headerlink" title="å†…å­˜å †"></a>å†…å­˜å †</h3><p>æ²¡ä»€ä¹ˆå¥½è®²çš„äº†ï¼Œå’Œä¸€èˆ¬çš„å †ç®¡ç†æœºåˆ¶å¤§åŒå°å¼‚ã€‚</p>
<p>mem.c ä¸­çš„æ•°ç»„å˜é‡ ram_heap[MEM_SIZE] å°±æ˜¯åˆ†é…çš„å †ç©ºé—´ï¼ŒMEM_SIZE é»˜è®¤æ˜¯ 1600ï¼Œç”¨æˆ·å¯åœ¨ lwipopts.h å†…è‡ªå®šä¹‰å¤§å°ã€‚</p>
<h3 id="ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜ç®¡ç†"><a href="#ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜ç®¡ç†" class="headerlink" title="ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜ç®¡ç†"></a>ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜ç®¡ç†</h3><p>LwIP è‡ªå¸¦çš„å†…å­˜æ± å¯ä»¥æä¾›é«˜æ•ˆç‡çš„åˆ†é…/å›æ”¶ï¼Œè‡ªå¸¦çš„å†…å­˜å †å¯ä»¥é¿å…åè®®æ ˆå†…å­˜å‡ºç°é—®é¢˜æ—¶å¯¹ç³»ç»Ÿå†…å­˜çš„å½±å“ã€‚</p>
<p>ä½†åœ¨ ARM MCU å¹³å°ä¸Šï¼Œç½‘ç»œæ€§èƒ½çš„ç“¶é¢ˆå¾€å¾€åœ¨äºå†…å­˜å¤§å°å’Œç½‘ç»œæœ¬èº«ï¼ŒCPU é€Ÿåº¦å·²è¶³å¤Ÿå¿«ï¼Œå†…å­˜æ± å’Œå†…å­˜å †çš„æ•ˆç‡å·®åˆ«ä¸å¤§ï¼Œå¦å¤–ï¼Œä¸ºåè®®æ ˆå•ç‹¬åˆ†é…å†…å­˜å †ä¹Ÿä¼šé€ æˆå†…å­˜æµªè´¹ï¼Œæ‰€ä»¥ LwIP æä¾›äº†é€‰é¡¹è®©åè®®æ ˆå…¨éƒ¨ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚</p>
<p>å®šä¹‰ MEM_LIBC_MALLOC ä¸º 1 è®©åè®®æ ˆä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜å †ï¼Œå®šä¹‰ MEMP_MEM_MALLOC ä¸º 1 è®©åè®®æ ˆç”¨å†…å­˜å †æ¥ä»£æ›¿å†…å­˜æ± [^1]ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * MEM_LIBC_MALLOC&#x3D;&#x3D;1: Use malloc&#x2F;free&#x2F;realloc provided by your C-library</span><br><span class="line"> * instead of the lwip internal allocator. Can save code size if you</span><br><span class="line"> * already use it.</span><br><span class="line"> *&#x2F;</span><br><span class="line">#if !defined MEM_LIBC_MALLOC || defined __DOXYGEN__</span><br><span class="line">#define MEM_LIBC_MALLOC                 0</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * MEMP_MEM_MALLOC&#x3D;&#x3D;1: Use mem_malloc&#x2F;mem_free instead of the lwip pool allocator.</span><br><span class="line"> * Especially useful with MEM_LIBC_MALLOC but handle with care regarding execution</span><br><span class="line"> * speed (heap alloc can be much slower than pool alloc) and usage from interrupts</span><br><span class="line"> * (especially if your netif driver allocates PBUF_POOL pbufs for received frames</span><br><span class="line"> * from interrupt)!</span><br><span class="line"> * ATTENTION: Currently, this uses the heap for ALL pools (also for private pools,</span><br><span class="line"> * not only for internal pools defined in memp_std.h)!</span><br><span class="line"> *&#x2F;</span><br><span class="line">#if !defined MEMP_MEM_MALLOC || defined __DOXYGEN__</span><br><span class="line">#define MEMP_MEM_MALLOC                 0</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šè‹¥ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜ç®¡ç†ï¼Œé‚£ä¹ˆæ¯ç±» pool çš„ä¸ªæ•°å°±ç”¨ä¸åˆ°äº†ï¼Œä½†æ˜¯åè®®æ ˆç¼–è¯‘æ—¶ä¼šåšæœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦å®šä¹‰ä¸€ä¸ªåˆé€‚çš„å€¼ã€‚</p>
<p>[^1]: ESP32 å°±æ˜¯è¿™æ ·åšçš„ã€‚</p>
<h2 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h2><p>LwIP å†…æœ‰å¤§é‡çš„å…¨å±€å˜é‡ï¼Œè¦ä¿è¯çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨åè®®æ ˆå‡½æ•°ï¼Œåè®®æ ˆæä¾›äº†ä¸¤ç§æ–¹æ³•ï¼š</p>
<ol>
<li>å‘åè®®æ ˆå®ˆæŠ¤çº¿ç¨‹ tcpip_thread å‘é€ TCPIP_MSG_CALLBACK æ¶ˆæ¯ï¼Œè®©å‡½æ•°åœ¨ tcpip_thread å†…è¿è¡Œï¼Œæ­¤æ—¶ tcpip_thread ç›¸å½“äºæ˜¯ worker threadã€‚</li>
<li>ç”¨æˆ·çº¿ç¨‹å’Œ tcpip_thread ä¹‹é—´é€šè¿‡ä¸€ä¸ª core-locking é”æ¥å®ç°äº’æ–¥ã€‚</li>
<li>é€šè¿‡è¿›/é€€ä¸´ç•ŒåŒºçš„æ–¹å¼æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚</li>
</ol>
<p>è¦ä½¿ç”¨ç¬¬ 2 ç§æ–¹æ³•ï¼Œè¦å®šä¹‰ LWIP_TCPIP_CORE_LOCKING ä¸º 1ï¼Œå…¶å®åè®®æ ˆä¸­é»˜è®¤å·²ç»å®šä¹‰ä¸º 1 äº†ï¼ŒLwIP æ¨èæŸäº›å‡½æ•°ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥è¿è¡Œï¼Œæ¯”å¦‚ lwip_set/getsockoptï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘èµ„æºå’Œæ—¶é—´çš„æ¶ˆè€—ã€‚</p>
<p>è¦ä½¿ç”¨ç¬¬ 3 ç§æ–¹æ³•ï¼Œè¦å®šä¹‰ SYS_ARCH_PROTECT ä¸º 1ï¼Œå¹¶å®ç° sys_arch_protect å’Œ sys_arch_unprotect å‡½æ•°ï¼Œåœ¨ LwIP ä¸­ä¸€èˆ¬æ˜¯ç”¨äº buffer æˆ– memory çš„åˆ†é…/é‡Šæ”¾ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ç›¸å¯¹æ–¹æ³• 2 é€Ÿåº¦æ›´å¿«ï¼Œå› ä¸ºæ–¹æ³• 2 å†…ç”¨æˆ·å‡½æ•°ä¸€å®šè¦ç­‰å¾… tcpip_thread åœ¨å¤„ç†å®Œæ‰€æœ‰çš„æ¶ˆæ¯åé‡Šæ”¾é”åæ‰èƒ½è¿è¡Œçš„ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯ä¼šé¢‘ç¹åœ°å¼€å…³ä¸­æ–­ã€‚ä¸€ä¸ªå…¸å‹çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">  This optional function does a &quot;fast&quot; critical region protection and returns</span><br><span class="line">  the previous protection level. This function is only called during very short</span><br><span class="line">  critical regions. An embedded system which supports ISR-based drivers might</span><br><span class="line">  want to implement this function by disabling interrupts. Task-based systems</span><br><span class="line">  might want to implement this by using a mutex or disabling tasking. This</span><br><span class="line">  function should support recursive calls from the same task or interrupt. In</span><br><span class="line">  other words, sys_arch_protect() could be called while already protected. In</span><br><span class="line">  that case the return value indicates that it is already protected.</span><br><span class="line"></span><br><span class="line">  sys_arch_protect() is only required if your port is supporting an operating</span><br><span class="line">  system.</span><br><span class="line">*&#x2F;</span><br><span class="line">sys_prot_t sys_arch_protect(void)</span><br><span class="line">&#123;</span><br><span class="line">	vPortEnterCritical();</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">  This optional function does a &quot;fast&quot; set of critical region protection to the</span><br><span class="line">  value specified by pval. See the documentation for sys_arch_protect() for</span><br><span class="line">  more information. This function is only required if your port is supporting</span><br><span class="line">  an operating system.</span><br><span class="line">*&#x2F;</span><br><span class="line">void sys_arch_unprotect(sys_prot_t pval)</span><br><span class="line">&#123;</span><br><span class="line">	( void ) pval;</span><br><span class="line">	vPortExitCritical();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SO_BINDTODEVICE</p>
<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><h3 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h3><p>ç”¨æˆ·è°ƒç”¨ gethostbyname åï¼Œå‘é€ callback æ¶ˆæ¯ç»™ tcpip_threadï¼Œå…ˆæŸ¥è¯¢ç¼“å­˜å†…æ˜¯å¦å·²ç»æœ‰äº†æ­¤é¡¹ï¼Œè‹¥æœ‰åˆ™ç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œè‹¥æ— åˆ™å‘é€ dns query è¯·æ±‚ã€‚åœ¨åº•å±‚é€’äº¤ä¸€ä¸ª UDP åŒ…åï¼Œè‹¥æ˜¯ DNS responseï¼Œåˆ™è§£æå¹¶è¿”å›ç»™ç”¨æˆ·ã€‚åŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª timer ä»¥å¤„ç†è¶…æ—¶é”™è¯¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">user</span><br><span class="line">â‡©</span><br><span class="line">lwip_gethostbyname</span><br><span class="line">â‡©</span><br><span class="line">netconn_gethostbyname</span><br><span class="line">â‡©</span><br><span class="line">tcpip_callback(lwip_netconn_do_gethostbyname)</span><br><span class="line">â‡©                    â‡£</span><br><span class="line">sys_sem_wait          â‡£</span><br><span class="line">â‡©                    â‡£</span><br><span class="line">return                â‡£</span><br><span class="line">---------------------------------------- query -------------------------------------------</span><br><span class="line">                      â‡£</span><br><span class="line">tcpip_thread          â‡£</span><br><span class="line">â‡©                    â‡£</span><br><span class="line">lwip_netconn_do_gethostbyname</span><br><span class="line">â‡©</span><br><span class="line">dns_gethostbyname_addrtype</span><br><span class="line">â‡©</span><br><span class="line">dns_lookup â‡¨(on found) sys_sem_signal</span><br><span class="line">â‡©</span><br><span class="line">dns_enqueue</span><br><span class="line">â‡©</span><br><span class="line">dns_check_entry</span><br><span class="line">â‡©</span><br><span class="line">dns_send</span><br><span class="line">â‡©</span><br><span class="line">udp_sendto</span><br><span class="line">------------------------------------- response -------------------------------------------</span><br><span class="line">udp_input</span><br><span class="line">â‡©</span><br><span class="line">dns_recv</span><br><span class="line">â‡©</span><br><span class="line">dns_correct_response</span><br><span class="line">â‡©</span><br><span class="line">dns_call_found</span><br><span class="line">â‡©</span><br><span class="line">lwip_netconn_do_dns_found</span><br><span class="line">â‡©</span><br><span class="line">sys_sem_signal</span><br><span class="line">-------------------------------------- timeout -------------------------------------------</span><br><span class="line">tcpip_thread</span><br><span class="line">â‡©</span><br><span class="line">(on timer expired)</span><br><span class="line">dns_timer</span><br><span class="line">â‡©</span><br><span class="line">dns_tmr</span><br><span class="line">â‡©</span><br><span class="line">dns_check_entries</span><br><span class="line">â‡©</span><br><span class="line">dns_check_entry</span><br><span class="line">â‡©</span><br><span class="line">(on maxium retries)</span><br><span class="line">dns_call_found(NULL)</span><br><span class="line">â‡©</span><br><span class="line">lwip_netconn_do_dns_found</span><br><span class="line">â‡©</span><br><span class="line">sys_sem_signal</span><br></pre></td></tr></table></figure>

<h3 id="é˜»å¡"><a href="#é˜»å¡" class="headerlink" title="é˜»å¡"></a>é˜»å¡</h3><p>ç”¨æˆ·çº¿ç¨‹åœ¨è°ƒç”¨ gethostbyname åï¼Œå°±é˜»å¡åœ¨ä¸€ä¸ªä¿¡å·é‡ä¸Šã€‚æœ‰ 3 ç§æƒ…å†µä¼š give ä¿¡å·é‡ï¼š</p>
<ol>
<li>ç¼“å†²ä¸­å·²æœ‰æ­¤é¡¹</li>
<li>æ”¶åˆ° dns response</li>
<li>è¶…æ—¶</li>
</ol>
<h3 id="è¶…æ—¶"><a href="#è¶…æ—¶" class="headerlink" title="è¶…æ—¶"></a>è¶…æ—¶</h3><p>å…¶ä¸­ï¼Œdns timer æ˜¯ DNS_TMR_INTERVALï¼Œlwip 2.0.2 ç‰ˆæœ¬æ˜¯ 1000msï¼Œé‡è¯•æ¬¡æ•°æ˜¯ DNS_MAX_RETRIESï¼Œé»˜è®¤æ˜¯ 4ï¼Œnum_dns é»˜è®¤æ˜¯ 1ï¼Œæ‰€ä»¥ dns è¶…æ—¶æ˜¯ 4 ç§’ã€‚</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>åšæŒåŸåˆ›æŠ€æœ¯åˆ†äº«ï¼Œæ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œï¼</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    æ‰“èµ
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="Snow Yang å¾®ä¿¡æ”¯ä»˜">
        <p>å¾®ä¿¡æ”¯ä»˜</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="Snow Yang æ”¯ä»˜å®">
        <p>æ”¯ä»˜å®</p>
      </div>

  </div>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/12/11/Network/TCPIP/TCPIP%20Hacking/" rel="prev" title="TCPIP Hacking">
      <i class="fa fa-chevron-left"></i> TCPIP Hacking
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/11/Network/TCPIP/LwIP/LwIP%20%E8%B7%A8%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C%20socket/" rel="next" title="LwIP è·¨çº¿ç¨‹æ“ä½œ socket">
      LwIP è·¨çº¿ç¨‹æ“ä½œ socket <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#LwIP"><span class="nav-number">1.</span> <span class="nav-text">LwIP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LwIP-%E7%90%86%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">LwIP ç†è§£</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LwIP-%E7%A7%BB%E6%A4%8D"><span class="nav-number">3.</span> <span class="nav-text">LwIP ç§»æ¤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LwIP-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">4.</span> <span class="nav-text">LwIP åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#netif-set-link-up-%E5%92%8C-netif-set-up-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.</span> <span class="nav-text">netif_set_link_up å’Œ netif_set_up çš„åŒºåˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C-DHCP-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0-netif-set-status-callback"><span class="nav-number">6.</span> <span class="nav-text">æ³¨å†Œ DHCP å›è°ƒå‡½æ•° - netif_set_status_callback()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NETIF-STATUS-CALLBACK"><span class="nav-number">6.1.</span> <span class="nav-text">NETIF_STATUS_CALLBACK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netif-set-addr"><span class="nav-number">6.2.</span> <span class="nav-text">netif_set_addr</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redefination-of-timeval"><span class="nav-number">7.</span> <span class="nav-text">Redefination of timeval</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS-%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="nav-number">8.</span> <span class="nav-text">DNS ç¼“å­˜é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS-%E8%BF%94%E5%9B%9E%E5%A4%9A%E4%B8%AA%E5%9C%B0%E5%9D%80"><span class="nav-number">9.</span> <span class="nav-text">DNS è¿”å›å¤šä¸ªåœ°å€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DHCP"><span class="nav-number">10.</span> <span class="nav-text">DHCP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C-DHCP-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="nav-number">10.1.</span> <span class="nav-text">æ³¨å†Œ DHCP å›è°ƒå‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-DHCP-dhcp-start"><span class="nav-number">10.2.</span> <span class="nav-text">å¯åŠ¨ DHCP - dhcp_start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DHCP-%E5%8A%A0%E9%80%9F"><span class="nav-number">10.3.</span> <span class="nav-text">DHCP åŠ é€Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A8%A1%E6%8B%9F%E5%B1%82%E7%A7%BB%E6%A4%8D"><span class="nav-number">11.</span> <span class="nav-text">æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚ç§»æ¤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP"><span class="nav-number">12.</span> <span class="nav-text">TCP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LwIP-%E4%B8%AD%E7%9A%84-ACK"><span class="nav-number">12.1.</span> <span class="nav-text">LwIP ä¸­çš„ ACK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%AF%E8%AE%A1%E7%A1%AE%E8%AE%A4"><span class="nav-number">12.2.</span> <span class="nav-text">ç´¯è®¡ç¡®è®¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8D%8E%E5%B8%A6%E7%A1%AE%E8%AE%A4"><span class="nav-number">12.3.</span> <span class="nav-text">æå¸¦ç¡®è®¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LwIP-%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%8F%E5%8A%9F%E8%83%BD%E4%B9%8B%E9%97%B4%E7%9A%84%E8%80%A6%E5%90%88%E6%80%A7"><span class="nav-number">13.</span> <span class="nav-text">LwIP å°½é‡å‡å°åŠŸèƒ½ä¹‹é—´çš„è€¦åˆæ€§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LwIP-%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA"><span class="nav-number">14.</span> <span class="nav-text">LwIP ä¸­çš„æ—¥å¿—è¾“å‡º</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LwIP-%E4%B8%AD%E7%9A%84%E5%8D%8F%E8%AE%AE%E6%8E%A7%E5%88%B6%E5%9D%97"><span class="nav-number">15.</span> <span class="nav-text">LwIP ä¸­çš„åè®®æ§åˆ¶å—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">16.</span> <span class="nav-text">å†…å­˜ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B1%A0"><span class="nav-number">16.1.</span> <span class="nav-text">å†…å­˜æ± </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%A0%86"><span class="nav-number">16.2.</span> <span class="nav-text">å†…å­˜å †</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">16.3.</span> <span class="nav-text">ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜ç®¡ç†</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="nav-number">17.</span> <span class="nav-text">çº¿ç¨‹å®‰å…¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS"><span class="nav-number">18.</span> <span class="nav-text">DNS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">18.1.</span> <span class="nav-text">æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E"><span class="nav-number">18.2.</span> <span class="nav-text">é˜»å¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6"><span class="nav-number">18.3.</span> <span class="nav-text">è¶…æ—¶</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Snow Yang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Snow Yang</p>
  <div class="site-description" itemprop="description">åƒå¤é£æµä»Šåœ¨æ­¤ï¼Œä¸‡é‡ŒåŠŸåè«æ”¾ä¼‘</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/smartsnow" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;smartsnow" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Snow Yang</span>
</div>
  <!-- <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>
  -->

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"PV6nn46hGfP8NYx7WwzusM8C-9Nh9j0Va","app_key":"icEREPKf8nKewGksI1Nw6KrM","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
